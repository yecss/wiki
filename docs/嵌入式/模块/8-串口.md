## 接收流程

现在的 USART2/USART3 接收流程是：

1. 用 **DMA 循环模式** 把数据搬到 `usartX_dma_buffer`。
2. **IDLE 中断**触发时，认为一帧结束，把 **整个 DMA buffer 里的数据（从头开始）**塞到环形控制块 (`UCB/UCB3`) 里。

## fix

```c
// USART3中断服务函数
// 修复接收重复的问题 - 2025年9月5日10:47:00
static uint16_t old_pos = 0;

void USART3_IRQHandler(void) {
    if (USART_GetITStatus(USART3, USART_IT_IDLE) != RESET) {
        volatile uint32_t tmp;
        tmp = USART3->SR;
        tmp = USART3->DR;

        DMA_Cmd(DMA1_Channel3, DISABLE);

        uint16_t remaining = DMA_GetCurrDataCounter(DMA1_Channel3);
        uint16_t new_pos   = U3_RX_SIZE - remaining;

        if (new_pos != old_pos) {
            if (new_pos > old_pos) {
                // 正常情况，数据连续
                UCB3_PutFrame(&usart3_cb,
                              &usart3_dma_buffer[old_pos],
                              &usart3_dma_buffer[new_pos]);
            } else {
                // 环绕情况：old_pos → 末尾，再从0 → new_pos
                UCB3_PutFrame(&usart3_cb,
                              &usart3_dma_buffer[old_pos],
                              &usart3_dma_buffer[U3_RX_SIZE]);
                if (new_pos > 0) {
                    UCB3_PutFrame(&usart3_cb,
                                  &usart3_dma_buffer[0],
                                  &usart3_dma_buffer[new_pos]);
                }
            }
        }

        old_pos = new_pos;

        DMA_Cmd(DMA1_Channel3, ENABLE);
    }
}

```

